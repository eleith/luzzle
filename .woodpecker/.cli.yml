workspace:
  base: /workspace
  path: src
steps:
  build:
    image: node:18
    commands:
      - npm ci -w @luzzle/cli -w @luzzle/kysely
      - npm run build -w @luzzle/kysely
      - npm run compile -w @luzzle/cli
      - npm run build -w @luzzle/cli
    when:
      event: [push]
      branch: [main]
      path:
        include: [".woodpecker/.cli.yml", "packages/cli/**"]
  test:
    image: node:18
    commands:
      - npm run lint -w @luzzle/cli
      - npm run test -w @luzzle/cli
    when:
      event: [push]
      branch: [main]
      path:
        include: [".woodpecker/.cli.yml", "packages/cli/**"]
  publish:
    image: node:18
    commands:
      - npm config set @luzzle:registry https://git.eleith.com/api/packages/$NPM_OWNER/npm/
      - npm config set -- "//git.eleith.com/api/packages/$NPM_OWNER/npm/:_authToken" "$NPM_TOKEN"
      - cd packages/cli
      - NPM_CURRENT_VERSION="$(npm pkg get version --workspaces=false)"
      - NPM_LATEST_VERSION="$(npm show . version --workspaces=false)"
      - cd ../..
      - if test $NPM_CURRENT_VERSION != \"$NPM_LATEST_VERSION\" ; then npm publish -w @luzzle/cli; fi
    secrets: [npm_owner, npm_token]
    when:
      event: [push]
      branch: [main]
      path:
        include: [".woodpecker/.cli.yml", "packages/cli/**"]
  notify:
    image: deblan/woodpecker-email:1.0.1-wp
    secrets:
      [
        smtp_notification_from,
        smtp_notification_host,
        smtp_notification_password,
        smtp_notification_from,
        smtp_notification_recipient,
      ]
    settings:
      from.address:
        from_secret: smtp_notification_from
      host:
        from_secret: smtp_notification_host
      password:
        from_secret: smtp_notification_password
      username:
        from_secret: smtp_notification_username
      recipients:
        from_secret: smtp_notification_recipient
    when:
      event: [push]
      status: [failure, success]
      branch: [main]
      path:
        include: [".woodpecker/.cli.yml", "packages/cli/**"]
